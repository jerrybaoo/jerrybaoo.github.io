---
layout: post
title:  "CometBFT å…±è¯†ç ”ç©¶"
date:   2023-08-30 17:51:18 +0800
categories: consensus
---

# Overview

ä¸ºä»€ä¹ˆéœ€è¦ç ”ç©¶ CometBFT å…±è¯†ï¼Œç ”ç©¶ä»–çš„å®é™…æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ

Settlement Layer æ˜¯åŸºäº Cosmos SDK å¼€å‘çš„é“¾ã€‚é“¾çš„æ€§èƒ½åœ¨å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸Šå–å†³äºå…±è¯†ã€‚

ç†è§£ CometBFT æœ‰åŠ©äºæˆ‘ä»¬æ ¹æ®è‡ªå·±çš„éœ€æ±‚å’Œåœºæ™¯é…ç½®**é“¾çš„å…±è¯†å‚æ•°**ã€‚ä¹Ÿæ›´å®¹æ˜“ç†è§£ block chain TPS ç«èµ›çš„æ„ä¹‰ã€‚

# CometBFT ç®€ä»‹

CometBFT æ˜¯ä¸“é—¨æœåŠ¡äº block chain çš„å…±è¯†ã€‚

å®ƒåœ¨æ¯ä¸ª block height ä¸Šè¾¾æˆ **ç¡®å®šæ€§**å…±è¯†ã€‚æ¯ä¸ª block height çš„å…±è¯†è¿‡ç¨‹æŒ‰ round è¿›è¡Œã€‚

ä¸€ä¸ªå®Œæ•´çš„ round åŒ…å«äº†ï¼šproposeï¼Œprovoteï¼Œprecommitã€‚

å¦‚æœä¸€ä¸ª round æ²¡æœ‰è¾¾æˆå…±è¯†ï¼Œé‚£ä¹ˆè¿›å…¥ä¸‹ä¸€ä¸ªroundï¼ˆæ ¹æ®å®é™…è¿è¡Œçš„ cosmos é“¾ï¼Œå¤§éƒ¨åˆ†çš„åŒºå—åœ¨ç¬¬ä¸€ä¸ª round å½“ä¸­å°±èƒ½è¾¾æˆå…±è¯†ï¼‰ã€‚æ¯ä¸ª round éƒ½ä¼šåˆ‡æ¢ proposerã€‚

## å…±è¯†æ¨è¿›æœºåˆ¶

CometBFT åœ¨ä¸€ä¸ª Round å½“ä¸­æ˜¯æŒ‰ç…§æ¯ä¸ªé˜¶æ®µçš„ timeout æ¥æ¨è¿›å…±è¯†ã€‚

<aside>
ğŸ’¡

è¿™å’Œ hotstuff å¾ˆä¸åŒï¼Œhotstuf æ¨è¿›å…±è¯†ä¸ä¾èµ– timeoutã€‚

Hotstuff å¦‚æœåœ¨æŸä¸ªé˜¶æ®µæœé›†åˆ°è¶³å¤Ÿçš„ votesï¼Œå°±ä¼šç«‹å³æ¨è¿›å…±è¯†åˆ°ä¸‹ä¸€é˜¶æ®µã€‚è¿™å°±æ„å‘³ç€ hostuff çš„æ€§èƒ½ï¼Œåªå–å†³äºèŠ‚ç‚¹é—´çš„æœ€å¤§ç½‘ç»œå»¶æ—¶ã€‚

</aside>

Timeout æ„å‘³ç€ç³»ç»Ÿå½“ä¸­å­˜åœ¨å¾ˆå¤šå»¶æ—¶å’Œç­‰å¾…ã€‚å»¶æ—¶å’Œç­‰å¾…æ„å‘³ç€æ•ˆç‡ä½ã€‚

<aside>
ğŸ’¡

å»¶æ—¶å¹¶ä¸æ˜¯ä¸€å®šæ˜¯åå¤„ã€‚å»¶æ—¶å¯ä»¥ç¡®ä¿å¤§å¤šæ•°è¯šå®èŠ‚ç‚¹èƒ½è·Ÿä¸Šç³»ç»Ÿçš„æœ€æ–°çŠ¶æ€ã€‚

ä½†æ˜¯åœ¨ç›®å‰çš„ block chain TPS ç«èµ›å½“ä¸­ï¼Œè¿™å·²ç»ä¸æ˜¯è€ƒè™‘çš„é‡ç‚¹äº†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°

hyperliquid é¡¹ç›®ä¸­ï¼Œå¯¹èŠ‚ç‚¹è¿è¥å•†æå‡ºäº†éå¸¸é«˜çš„è¦æ±‚ã€‚æŸäº›èŠ‚ç‚¹è¿è¡Œå•†ç§°åœ¨èŠ‚ç‚¹è¿ç§»åˆ°ä¸œäº¬åï¼Œé™ä½äº†è¢«ç›‘ç¦çš„æ¦‚ç‡ã€‚

</aside>

### Propose

åœ¨ Propose é˜¶æ®µï¼Œproposer å‡†å¤‡ proposalï¼ŒåŒæ—¶è®¾ç½® prevote timetoutã€‚

å‡è®¾ timeout ä¸º 3sï¼Œé‚£å°±æ„å‘³ç€ 3s åï¼Œç³»ç»Ÿè¿›å…¥ prevote é˜¶æ®µã€‚å¦‚æœç³»ç»Ÿåœ¨ 3s å†…æ²¡æœ‰å‡†å¤‡å¥½ proposalï¼Œé‚£ä¹ˆç³»ç»Ÿå°† prevote niiã€‚æ˜¾ç„¶è¿™è½®ï¼ˆRoundï¼‰ä¼šå¤±è´¥ï¼Œè€Œè¿›å…¥ä¸‹ä¸€ roundã€‚

Proposal çš„åŒ…å«äº†ï¼Œä¸Šä¸€åŒºå—çš„ appHash ï¼ˆçŠ¶æ€æ ¹ï¼‰ï¼Œå½“å‰ height è¢«åŒ…å«çš„äº¤æ˜“ã€‚

<aside>
ğŸ’¡

CometBFT åªä¼šåœ¨ commit é˜¶æ®µæ‰§è¡Œ proposal ä¸­çš„äº¤æ˜“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…±è¯†è¿‡ç¨‹ä¸­ä¸ä¼šå°±çŠ¶æ€è¾¾æˆä¸€è‡´ã€‚è€Œæ˜¯åœ¨ä¸‹ä¸€ä¸ª blockçš„ å…±è¯†ä¸­ï¼Œæ£€æµ‹æœ¬è½® proposal å¼•èµ·çš„çŠ¶æ€è½¬æ¢ã€‚

</aside>

### Provote

æŒç»­æ”¶é›† proposal çš„ voteã€‚è¿™ä¹Ÿæ˜¯é  timeout æ¨è¿›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå¦‚æœä¸€ä¸ª timeout å†…æ²¡æœ‰æ”¶é›†åˆ°è¶³å¤Ÿçš„ voteï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¼šé€æ¸å¢åŠ  timeout æ—¶é—´ã€‚

æ”¶é›†åˆ°è¶³å¤Ÿçš„ vote åï¼Œç³»ç»Ÿè¿›å…¥ precommitã€‚

### Precommit

ç±»ä¼¼ provote çš„è¿‡ç¨‹ã€‚æ”¶é›†åˆ° è¶³å¤Ÿçš„æŠ•ç¥¨åã€‚ç³»ç»Ÿå¼€å§‹ commit blockã€‚å¹¶è®¾ç½® propose timeoutã€‚

## å‡ ä¸ªé‡è¦çš„å…±è¯†å‚æ•°

æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œcometbft çš„å…±è¯†æ¨è¿›éå¸¸ä¾èµ– timeoutã€‚é‚£ä¹ˆæ ¹æ®è‡ªèº«çš„åœºæ™¯é€‰æ‹©å‚æ•°éå¸¸é‡è¦ã€‚

```python
type ConsensusConfig struct {
	RootDir string `mapstructure:"home"`
	WalPath string `mapstructure:"wal_file"`
	walFile string // overrides WalPath if set

	// How long we wait for a proposal block before prevoting nil
	TimeoutPropose time.Duration `mapstructure:"timeout_propose"`
	// How much timeout_propose increases with each round
	TimeoutProposeDelta time.Duration `mapstructure:"timeout_propose_delta"`
	// How long we wait after receiving +2/3 prevotes for â€œanythingâ€ (ie. not a single block or nil)
	TimeoutPrevote time.Duration `mapstructure:"timeout_prevote"`
	// How much the timeout_prevote increases with each round
	TimeoutPrevoteDelta time.Duration `mapstructure:"timeout_prevote_delta"`
	// How long we wait after receiving +2/3 precommits for â€œanythingâ€ (ie. not a single block or nil)
	TimeoutPrecommit time.Duration `mapstructure:"timeout_precommit"`
	// How much the timeout_precommit increases with each round
	TimeoutPrecommitDelta time.Duration `mapstructure:"timeout_precommit_delta"`
	// How long we wait after committing a block, before starting on the new
	// height (this gives us a chance to receive some more precommits, even
	// though we already have +2/3).
	// NOTE: when modifying, make sure to update time_iota_ms genesis parameter
	TimeoutCommit time.Duration `mapstructure:"timeout_commit"`

	// Make progress as soon as we have all the precommits (as if TimeoutCommit = 0)
	SkipTimeoutCommit bool `mapstructure:"skip_timeout_commit"`

	// EmptyBlocks mode and possible interval between empty blocks
	CreateEmptyBlocks         bool          `mapstructure:"create_empty_blocks"`
	CreateEmptyBlocksInterval time.Duration `mapstructure:"create_empty_blocks_interval"`

	// Reactor sleep duration parameters
	PeerGossipSleepDuration     time.Duration `mapstructure:"peer_gossip_sleep_duration"`
	PeerQueryMaj23SleepDuration time.Duration `mapstructure:"peer_query_maj23_sleep_duration"`

	DoubleSignCheckHeight int64 `mapstructure:"double_sign_check_height"`
}

// DefaultConsensusConfig returns a default configuration for the consensus service
func DefaultConsensusConfig() *ConsensusConfig {
	return &ConsensusConfig{
		WalPath:                     filepath.Join(DefaultDataDir, "cs.wal", "wal"),
		TimeoutPropose:              3000 * time.Millisecond,
		TimeoutProposeDelta:         500 * time.Millisecond,
		TimeoutPrevote:              1000 * time.Millisecond,
		TimeoutPrevoteDelta:         500 * time.Millisecond,
		TimeoutPrecommit:            1000 * time.Millisecond,
		TimeoutPrecommitDelta:       500 * time.Millisecond,
		TimeoutCommit:               1000 * time.Millisecond,
		SkipTimeoutCommit:           false,
		CreateEmptyBlocks:           true,
		CreateEmptyBlocksInterval:   0 * time.Second,
		PeerGossipSleepDuration:     100 * time.Millisecond,
		PeerQueryMaj23SleepDuration: 2000 * time.Millisecond,
		DoubleSignCheckHeight:       int64(0),
	}
}

```

1. TimeoutCommit & SkipTimeoutCommit

æ›´æ”¹è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ commit block åï¼Œç«‹å³å¼€å¯ä¸‹ä¸€ height å…±è¯†ã€‚è¿™ä¸ªå‚æ•°çš„å¼€å¯çš„æ„ä¹‰åœ¨äºï¼Œå»¶æ—¶è®©å¤§å¤šæ•°èŠ‚ç‚¹ä¿æŒåŒæ­¥ã€‚

1. TimeoutPropose

é»˜è®¤çš„ TimeoutPropose è®¾ç½®çš„éå¸¸é•¿ï¼Œè¾¾åˆ° 3Sï¼Œè€Œ Commitï¼ˆæ‰§è¡Œï¼‰ æ—¶é—´ä»…ä»… 1Sã€‚è¿™æ ·åšçš„æ„ä¹‰åœ¨äºèƒ½è®© block å°½å¯èƒ½åŒ…å«æ›´å¤šçš„äº¤æ˜“ã€‚

é‚£ä¹ˆæŸäº›åœºæ™¯å¯ä»¥ç¼©çŸ­ propose æ—¶é—´ã€‚

1. TimeoutPrecommit & TimeoutPrevote å¯ä»¥ç¼©å°ï¼Œåœ¨èŠ‚ç‚¹éå¸¸å°‘çš„æƒ…å†µä¸‹ã€‚

<aside>
ğŸ’¡

åœ¨åªæœ‰å‡ ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œè¿½æ±‚äº¤æ˜“çš„å¿«é€Ÿç¡®è®¤ï¼Œé‚£ä¹ˆ cometbft å®Œå…¨å¯ä»¥åœ¨ 500ms ç¡®è®¤ä¸€ä¸ªå—ã€‚

**å½“ç„¶è¿™å¾ˆè¿èƒŒå» web3 çš„ä¸­å¿ƒåŒ–ç²¾ç¥ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ block chain TPS ç«èµ›æœ‰æ—¶æ¯«æ— æ„ä¹‰ã€‚**

</aside>